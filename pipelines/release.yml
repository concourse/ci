# the following vars must be specified:
#
#   ((release_major))                   the MAJOR version, e.g. 6
#   ((release_minor))                   the MAJOR.MINOR version, e.g. 6.1
#                                       concourse matches the desired release version
#   ((concourse_smoke_deployment_name)) a unique name for the smoke bosh deployment
#   ((latest_release))                  the latest concourse/concourse tag for upgrade testing.
#                                       e.g. 6.6.x -> 6.5, 7.0.x -> 6.7
#   ((resource_type_versions))          a YAML object containing the semver constraints for each of the base resource types. should default to "" for each type for a new release (i.e. no constraint).
#
# the following git branches need to be created:
#
#   concourse/concourse                 release/((release_minor)).x
#   concourse/concourse-bosh-release    release/((release_minor)).x
#   concourse/concourse-bosh-deployment release/((release_minor)).x
#   concourse/concourse-chart           release/((release_minor)).x
#
# everything else will be managed by the pipeline

meta:
  icons:
    - &release-icon package-variant-closed
    - &git-icon github
    - &image-icon docker

resource_types:
  - name: gcs
    type: registry-image
    source: { repository: frodenas/gcs-resource }

  - name: bosh-release
    type: registry-image
    source: { repository: dpb587/bosh-release-resource }

  - name: bosh-deployment
    type: registry-image
    source: { repository: cloudfoundry/bosh-deployment-resource }

  - name: helm-chart
    type: registry-image
    source: { repository: concourse/helm-chart-resource }

  - name: pull-request
    type: registry-image
    source: { repository: aoldershaw/github-pr-resource }

groups:
  - name: develop
    jobs:
      - reconfigure-prs
      - unit
      - unit-*
      - integration
      - resource-types-images
      - dev-image
      - testflight
      - worker-runtime
      - watsjs
      - rc
      - build-rc
      - build-rc-image
      - scan-rc-image
      - bin-smoke
      - bump-prod-to-rc

  - name: k8s
    jobs:
      - k8s-*

  - name: bosh
    jobs:
      - bosh-*

  - name: publish
    jobs:
      - create-draft-release
      - shipit
      - publish-binaries
      - publish-image
      - publish-bosh-release
      - bump-cbd-versions
      - patch
      - pin-resource-type-versions

  - name: all
    jobs:
      - "*"

jobs:
  - name: reconfigure-prs
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: ci
            resource: ci-pr-pipeline
            trigger: true
          - get: concourse-prs
            trigger: true
      - load_var: concourse_prs
        file: concourse-prs/prs.json
      - across:
          - var: pr
            values: ((.:concourse_prs))
            max_in_flight: all
        set_pipeline: pr
        team: contributor
        file: ci/pipelines/pr.yml
        instance_vars:
          number: ((.:pr.number))
        vars:
          branch: release/((release_minor)).x
          dev_image_tag: release-((release_minor))
          concourse_image_tag: ((release_minor))

  - name: unit
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            trigger: true
          - get: unit-image
            trigger: true
          - get: periodic-check
            trigger: true
          - get: ci
      - task: unit
        timeout: 1h
        image: unit-image
        file: ci/tasks/unit/task.yml

  - name: unit-yarn
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            trigger: true
          - get: unit-image
            trigger: true
          - get: periodic-check
            trigger: true
          - get: ci
      - timeout: 1h
        in_parallel:
          - task: yarn-test
            attempts: 3
            image: unit-image
            file: ci/tasks/yarn-test/task.yml
          - task: yarn-analyse
            attempts: 3
            image: unit-image
            file: ci/tasks/yarn-analyse/task.yml
          - task: yarn-benchmark
            attempts: 3
            image: unit-image
            file: ci/tasks/yarn-benchmark/task.yml

  - name: unit-baggageclaim
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            trigger: true
          - get: unit-image
            trigger: true
          - get: periodic-check
            trigger: true
          - get: ci
      - timeout: 1h
        in_parallel:
          - task: unit-baggageclaim
            image: unit-image
            privileged: true
            attempts: 3
            file: ci/tasks/unit-baggageclaim/task.yml
          - task: unit-baggageclaim-windows
            attempts: 3
            file: ci/tasks/unit-baggageclaim-windows/task.yml

  - name: unit-fly-windows
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            trigger: true
          - get: unit-image
            trigger: true
          - get: periodic-check
            trigger: true
          - get: ci
      - task: fly-windows
        attempts: 3
        file: ci/tasks/fly-windows/task.yml

  - name: resource-types-images
    public: true
    serial: true
    plan:
      - in_parallel:
          fail_fast: true
          steps:
            - get: periodic-check
              trigger: true
            - get: oci-build-task
            - get: ci
            #amd64
            - get: registry-image-amd64
              resource: registry-image-resource
              trigger: true
              params: &amd64
                platform:
                  architecture: amd64
            - get: docker-image-amd64
              resource: docker-image-resource
              trigger: true
              params: *amd64
            - get: git-amd64
              resource: git-resource
              trigger: true
              params: *amd64
            - get: hg-amd64
              resource: hg-resource
              trigger: true
              params: *amd64
            - get: semver-amd64
              resource: semver-resource
              trigger: true
              params: *amd64
            - get: s3-amd64
              resource: s3-resource
              trigger: true
              params: *amd64
            - get: pool-amd64
              resource: pool-resource
              trigger: true
              params: *amd64
            - get: mock-amd64
              resource: mock-resource
              trigger: true
              params: *amd64
            - get: bosh-io-release-amd64
              resource: bosh-io-release-resource
              trigger: true
              params: *amd64
            - get: time-amd64
              resource: time-resource
              trigger: true
              params: *amd64
            - get: bosh-io-stemcell-amd64
              resource: bosh-io-stemcell-resource
              trigger: true
              params: *amd64
            - get: github-release-amd64
              resource: github-release-resource
              trigger: true
              params: *amd64
            # arm64
            - get: registry-image-arm64
              resource: registry-image-resource
              trigger: true
              params: &arm64
                platform:
                  architecture: arm64
            - get: docker-image-arm64
              resource: docker-image-resource
              trigger: true
              params: *arm64
            - get: git-arm64
              resource: git-resource
              trigger: true
              params: *arm64
            - get: hg-arm64
              resource: hg-resource
              trigger: true
              params: *arm64
            - get: semver-arm64
              resource: semver-resource
              trigger: true
              params: *arm64
            - get: s3-arm64
              resource: s3-resource
              trigger: true
              params: *arm64
            - get: pool-arm64
              resource: pool-resource
              trigger: true
              params: *arm64
            - get: mock-arm64
              resource: mock-resource
              trigger: true
              params: *arm64
            - get: bosh-io-release-arm64
              resource: bosh-io-release-resource
              trigger: true
              params: *arm64
            - get: time-arm64
              resource: time-resource
              trigger: true
              params: *arm64
            - get: bosh-io-stemcell-arm64
              resource: bosh-io-stemcell-resource
              trigger: true
              params: *arm64
            - get: github-release-arm64
              resource: github-release-resource
              trigger: true
              params: *arm64
      - task: build
        image: oci-build-task
        privileged: true
        file: ci/tasks/build-resource-types-image/task.yml
      - put: resource-types-image
        no_get: true
        inputs: detect
        params:
          image: image/image

  - name: dev-image
    public: true
    serial: true
    plan:
      - in_parallel:
          fail_fast: true
          steps:
            - get: concourse
              trigger: true
            - get: golang-builder-image-rootfs
              resource: golang-builder-image
              trigger: true
              params: { format: rootfs }
            - get: golang-builder-image
              trigger: true
              params: { format: oci-layout }
            - get: containerd
              trigger: true
            - get: runc
              trigger: true
            - get: gdn
              trigger: true
            - get: cni
              trigger: true
            - get: dumb-init
              trigger: true
            - get: resource-types-amd64
              resource: resource-types-image
              passed: [resource-types-images]
              trigger: true
              params: *amd64
            - get: resource-types-arm64
              resource: resource-types-image
              passed: [resource-types-images]
              trigger: true
              params: *arm64
            - get: unit-image
            - get: oci-build-task
            - get: ci
      - in_parallel:
          fail_fast: true
          steps:
            - task: yarn-build
              image: unit-image
              file: ci/tasks/yarn-build/task.yml
            - task: fly-linux
              image: golang-builder-image-rootfs
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-linux
              params:
                PLATFORMS: linux/amd64,linux/arm64
            - task: fly-darwin
              image: golang-builder-image-rootfs
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-darwin
              params:
                PLATFORMS: darwin/amd64,darwin/arm64
            - task: fly-windows
              image: golang-builder-image-rootfs
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-windows
              params:
                PLATFORMS: windows/amd64
      - task: build
        image: oci-build-task
        privileged: true
        attempts: 3
        input_mapping:
          concourse: built-concourse
          base-image: golang-builder-image
        file: ci/tasks/build-dev-image/task.yml
        params:
          IMAGE_ARG_base_image: base-image/oci
      - put: dev-image
        no_get: true
        inputs: detect
        params:
          image: image/image

  - name: worker-runtime
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed:
              [unit, unit-yarn, unit-baggageclaim, unit-fly-windows, dev-image]
            trigger: true
          - get: dev-image
            passed: [dev-image]
            trigger: true
          - get: ci
      - task: integration
        image: dev-image
        privileged: true
        timeout: 1h
        file: ci/tasks/containerd-integration/task.yml

  - name: testflight
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed:
              [unit, unit-yarn, unit-baggageclaim, unit-fly-windows, dev-image]
            trigger: true
          - get: dev-image
            passed: [dev-image]
            trigger: true
            params: { format: oci }
          - get: postgres-image
            params: { format: oci }
          - get: unit-image
          - get: ci
      - across:
          - var: runtime
            values:
              - guardian
              - containerd
            max_in_flight: all
        task: testflight
        image: unit-image
        privileged: true
        timeout: 1h
        params:
          RUNTIME: ((.:runtime))
        file: ci/tasks/testflight/task.yml

  - name: watsjs
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed:
              [unit, unit-yarn, unit-baggageclaim, unit-fly-windows, dev-image]
            trigger: true
          - get: dev-image
            passed: [dev-image]
            trigger: true
            params: { format: oci }
          - get: postgres-image
            params: { format: oci }
          - get: unit-image
          - get: ci
      - task: watsjs
        attempts: 3
        image: unit-image
        privileged: true
        timeout: 1h
        file: ci/tasks/watsjs/task.yml

  - name: integration
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed:
              [unit, unit-yarn, unit-baggageclaim, unit-fly-windows, dev-image]
            trigger: true
          - get: dev-image
            passed: [dev-image]
            params: { format: oci }
            trigger: true
          - get: latest-concourse-image
            params: { format: oci }
          - get: postgres-image
            params: { format: oci }
          - get: vault-image
            params: { format: oci }
          - get: unit-image
          - get: ci
      - task: integration
        privileged: true
        image: unit-image
        file: ci/tasks/integration-tests/task.yml
        input_mapping:
          concourse-image: latest-concourse-image

  - name: k8s-smoke
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [build-rc-image]
            trigger: true
          - get: concourse-rc-image
            passed: [build-rc-image]
            params: { format: oci }
            trigger: true
          - get: version
            passed: [build-rc-image]
            trigger: true
          - get: concourse-chart
          - get: unit-image
          - get: ci
      - try:
          task: try-delete
          image: unit-image
          file: ci/tasks/k8s-smoke/delete.yml
          params:
            SERVICE_ACCOUNT_KEY: ((k8s_topgun.service_account_key))
            RELEASE_NAME: ((concourse_smoke_deployment_name))
            CONCOURSE_IMAGE: concourse/concourse-rc
      - task: deploy
        image: unit-image
        input_mapping: { image-info: concourse-rc-image }
        file: ci/tasks/k8s-smoke/deploy.yml
        params:
          SERVICE_ACCOUNT_KEY: ((k8s_topgun.service_account_key))
          RELEASE_NAME: ((concourse_smoke_deployment_name))
          CONCOURSE_IMAGE: concourse/concourse-rc
      - task: k8s-smoke
        image: unit-image
        file: ci/tasks/k8s-smoke/tests.yml
        attempts: 3
        params:
          SERVICE_ACCOUNT_KEY: ((k8s_topgun.service_account_key))
          RELEASE_NAME: ((concourse_smoke_deployment_name))
          MAX_TICKS: 300
    ensure:
      task: delete
      image: unit-image
      file: ci/tasks/k8s-smoke/delete.yml
      params:
        SERVICE_ACCOUNT_KEY: ((k8s_topgun.service_account_key))
        RELEASE_NAME: ((concourse_smoke_deployment_name))
        CONCOURSE_IMAGE: concourse/concourse-rc

  - name: k8s-topgun
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            tags: [k8s-topgun]
            passed: [k8s-smoke]
            trigger: true
          - get: version
            tags: [k8s-topgun]
            passed: [k8s-smoke]
            trigger: true
          - get: concourse-rc-image
            tags: [k8s-topgun]
            passed: [k8s-smoke]
            trigger: true
            params: { format: oci }
          - get: unit-image
          - get: prometheus-chart
            tags: [k8s-topgun]
            params: { untar: true }
          - get: postgresql-chart-git
            tags: [k8s-topgun]
          - get: concourse-chart
            trigger: true
            passed: [k8s-smoke]
            tags: [k8s-topgun]
          - get: ci
            tags: [k8s-topgun]
      - task: k8s-topgun
        file: ci/tasks/k8s-topgun/task.yml
        image: unit-image
        tags: [k8s-topgun]
        params:
          IN_CLUSTER: "true"
          SERVICE_ACCOUNT_KEY: ((k8s_topgun.service_account_key))
          CONCOURSE_IMAGE_NAME: concourse/concourse-rc

  - name: k8s-check-helm-params
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [build-rc-image]
            trigger: true
          - get: concourse-rc-image
            passed: [build-rc-image]
            trigger: true
          - get: version
            passed: [build-rc-image]
            trigger: true
          - get: unit-image
          - get: concourse-chart
            trigger: true
          - get: linux-rc
            resource: linux-amd64-rc
            passed: [bin-smoke]
            trigger: true
          - get: ci
      - task: check-params
        file: ci/tasks/check-distribution-env/task.yml
        image: unit-image
        input_mapping:
          distribution: concourse-chart
        params:
          DISTRIBUTION: helm

  - name: rc
    public: true
    serial_groups: [version]
    plan:
      - in_parallel:
          - get: concourse
            passed: [testflight, watsjs, integration, worker-runtime]
            trigger: true
          - get: dev-image
            trigger: true
            passed: [testflight, watsjs, integration, worker-runtime]
            params:
              skip_download: true
          - get: golang-builder-image
            passed: [dev-image]
            params:
              skip_download: true
      - put: version
        no_get: true
        inputs: detect
        params: { pre: rc }

  - name: build-rc
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [rc]
            trigger: true
          - get: unit-image
          - get: ci
          - get: golang-builder-image
            passed: [rc]
          - get: version
            passed: [rc]
            trigger: true
          - get: final-version
            resource: version
            passed: [rc]
            params: { bump: final }
          - get: dev-amd64
            resource: dev-image
            passed: [rc]
            trigger: true
            params: *amd64
          - get: dev-arm64
            resource: dev-image
            passed: [rc]
            trigger: true
            params: *arm64
          - get: resource-types-amd64
            resource: resource-types-image
            passed: [dev-image]
            trigger: true
            params: *amd64
          - get: resource-types-arm64
            resource: resource-types-image
            passed: [dev-image]
            trigger: true
            params: *arm64
      - in_parallel:
          fail_fast: true
          steps:
            - task: fly-linux
              image: golang-builder-image
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-linux
              params:
                PLATFORMS: linux/amd64,linux/arm64
            - task: fly-darwin
              image: golang-builder-image
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-darwin
              params:
                PLATFORMS: darwin/amd64,darwin/arm64
            - task: fly-windows
              image: golang-builder-image
              file: ci/tasks/fly-build/task.yml
              output_mapping:
                fly-builds: fly-windows
              params:
                PLATFORMS: windows/amd64
            - task: yarn-build
              file: ci/tasks/yarn-build/task.yml
              image: unit-image
            - task: get-rc-version
              file: ci/tasks/get-rc-version/task.yml
              image: golang-builder-image
      - in_parallel:
          fail_fast: true
          steps:
            - task: concourse-linux
              image: golang-builder-image
              file: ci/tasks/concourse-build/task.yml
              input_mapping:
                concourse: built-concourse
              output_mapping:
                concourse-tarballs: concourse-linux
              params:
                PLATFORMS: linux/amd64,linux/arm64
            - task: concourse-darwin
              image: golang-builder-image
              file: ci/tasks/concourse-build/task.yml
              input_mapping:
                concourse: built-concourse
              output_mapping:
                concourse-tarballs: concourse-darwin
              params:
                PLATFORMS: darwin/amd64,darwin/arm64
            - task: concourse-windows
              image: golang-builder-image
              file: ci/tasks/concourse-build/task.yml
              input_mapping:
                concourse: built-concourse
              output_mapping:
                concourse-tarballs: concourse-windows
              params:
                PLATFORMS: windows/amd64
      - in_parallel:
          - task: validate-linux-rc
            image: unit-image
            file: ci/tasks/validate-linux-rc/task.yml
          - task: validate-windows-rc
            file: ci/tasks/validate-windows-rc/task.yml
      - in_parallel:
          - put: linux-amd64-rc
            no_get: true
            inputs: detect
            params: { file: concourse-linux/concourse-*.amd64.tgz }
          - put: linux-arm64-rc
            no_get: true
            inputs: detect
            params: { file: concourse-linux/concourse-*.arm64.tgz }
          - put: darwin-amd64-rc
            no_get: true
            inputs: detect
            params: { file: concourse-darwin/concourse-*.amd64.tgz }
          - put: darwin-arm64-rc
            no_get: true
            inputs: detect
            params: { file: concourse-darwin/concourse-*.arm64.tgz }
          - put: windows-amd64-rc
            no_get: true
            inputs: detect
            params: { file: concourse-windows/concourse-*.amd64.zip }

  - name: build-rc-image
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [build-rc]
            trigger: true
          - get: unit-image
          - get: version
            passed: [build-rc]
            trigger: true
          - get: linux-amd64
            resource: linux-amd64-rc
            trigger: true
            passed: [build-rc]
          - get: linux-arm64
            resource: linux-arm64-rc
            trigger: true
            passed: [build-rc]
          - get: concourse-docker
            trigger: true
          - get: oci-build-task
          - get: ci
      - task: build
        file: concourse-docker/ci/build-image.yml
        image: oci-build-task
        privileged: true
      - put: concourse-rc-image
        no_get: true
        inputs: detect
        params:
          image: image/image
          additional_tags: version/version

  - name: bump-prod-to-rc
    plan:
      - in_parallel:
          - get: infrastructure
          - get: concourse-image
            resource: concourse-rc-image
            passed: [build-rc-image]
            params: { skip_download: true }
          - get: concourse-windows
            resource: windows-amd64-rc
            passed: [build-rc]
            params: { skip_download: "true" }
          - get: concourse-darwin
            resource: darwin-amd64-rc
            passed: [build-rc]
            params: { skip_download: "true" }
      - load_var: concourse_image_repo
        file: concourse-image/repository
      - load_var: concourse_image_digest
        file: concourse-image/digest
      - task: convert-windows-url
        file: infrastructure/tasks/convert-gs-url.yml
        input_mapping: { input: concourse-windows }
        output_mapping: { output: windows }
      - task: convert-darwin-url
        file: infrastructure/tasks/convert-gs-url.yml
        input_mapping: { input: concourse-darwin }
        output_mapping: { output: darwin }
      - load_var: concourse_windows_bundle_url
        file: windows/url
      - load_var: concourse_darwin_bundle_url
        file: darwin/url
      - task: bump-versions
        file: infrastructure/tasks/replace-file.yml
        input_mapping: { repo: infrastructure }
        output_mapping: { repo-bumped: infrastructure-bumped }
        params:
          FILE: terraform/environments/production/variables.yml
          CONTENT: |
            concourse_web_image_repo: ((.:concourse_image_repo))
            concourse_web_image_digest: ((.:concourse_image_digest))
            concourse_worker_image_repo: ((.:concourse_image_repo))
            concourse_worker_image_digest: ((.:concourse_image_digest))
            concourse_windows_bundle_url: ((.:concourse_windows_bundle_url))
            concourse_darwin_bundle_url: ((.:concourse_darwin_bundle_url))
          COMMIT: bump production to ((release_minor)) rc
      - put: infrastructure-bump
        no_get: true
        inputs: detect
        params:
          repository: infrastructure-bumped
          branch: master

  - name: scan-rc-image
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse-rc-image
            passed: [build-rc-image]
            params: { format: oci }
            trigger: true
          - get: concourse-rc-image-rootfs
            resource: concourse-rc-image
            passed: [build-rc-image]
            params: { format: rootfs }
            trigger: true
          - get: ci
          - get: wolfi-base
      - task: extract-trivy-db
        image: wolfi-base
        file: ci/tasks/extract-trivy-db/task.yml
      - in_parallel:
          - task: scan-concourse
            file: ci/tasks/scan-image/task.yml
            image: wolfi-base
            input_mapping: { image: concourse-rc-image }
            params:
              IGNORE_POLICY_FILE: ci/trivy-ignore/((release_minor))-image.rego
          - task: scan-resource-types
            file: ci/tasks/scan-resource-types/task.yml
            image: wolfi-base
            input_mapping: { image: concourse-rc-image-rootfs }
            params:
              IGNORE_POLICY_FILE: ci/trivy-ignore/((release_minor))-resource-types.rego

  - name: bin-smoke
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [build-rc]
            trigger: true
          - get: version
            passed: [build-rc]
            trigger: true
          - get: linux-amd64-rc
            passed: [build-rc]
            trigger: true
          - get: linux-arm64-rc
            passed: [build-rc]
            trigger: true
          - get: unit-image
          - get: ci
      - load_var: concourse_version
        file: version/version
      - across:
          - var: runtime
            values:
              - runtime: guardian
                arch: amd64
              - runtime: containerd
                arch: amd64
              - runtime: containerd
                arch: arm64
            max_in_flight: all
          - var: gcp-image
            values:
              - ubuntu-2204-lts
              - ubuntu-2404-lts
            max_in_flight: 1
        timeout: 40m
        do:
          - do:
              - task: terraform-apply
                image: unit-image
                file: ci/tasks/terraform-smoke/task.yml
                input_mapping: { linux-rc: linux-((.:runtime.arch))-rc }
                params:
                  GCP_PROJECT: cf-concourse-production
                  GCP_KEY: ((concourse_smoke_gcp_key))
                  SSH_KEY: ((concourse_smoke_ssh_key))
                  WORKSPACE: release-((release_minor))-((.:runtime.runtime))-((.:runtime.arch))
                  CONCOURSE_VERSION: ((.:concourse_version))
                  TF_VAR_GCP_IMAGE: ((.:gcp-image))
                  TF_VAR_RUNTIME: ((.:runtime.runtime))
                  TF_VAR_ARCH: ((.:runtime.arch))
              - task: smoke-test
                image: unit-image
                file: ci/tasks/smoke-test/task.yml
                input_mapping: { endpoint-info: outputs }
                params: { MAX_TICKS: 300 }
            ensure:
              task: terraform-cleanup
              image: unit-image
              file: ci/tasks/terraform-smoke/cleanup.yml
              params:
                GCP_PROJECT: cf-concourse-production
                GCP_KEY: ((concourse_smoke_gcp_key))
                SSH_KEY: ((concourse_smoke_ssh_key))
                WORKSPACE: release-((release_minor))-((.:runtime.runtime))-((.:runtime.arch))
                CONCOURSE_VERSION: ((.:concourse_version))
                TF_VAR_GCP_IMAGE: ((.:gcp-image))
                TF_VAR_RUNTIME: ((.:runtime.runtime))
                TF_VAR_ARCH: ((.:runtime.arch))

  - name: bosh-check-props
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [bin-smoke]
            trigger: true
          - get: unit-image
          - get: version
            passed: [bin-smoke]
            trigger: true
          - get: linux-rc
            resource: linux-amd64-rc
            passed: [bin-smoke]
            trigger: true
          - get: concourse-release-repo
            trigger: true
          - get: ci
      - task: check-props
        file: ci/tasks/check-distribution-env/task.yml
        image: unit-image
        input_mapping:
          distribution: concourse-release-repo
        params: { DISTRIBUTION: bosh }

  - name: bosh-bump
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: concourse
            passed: [build-rc]
            trigger: true
          - get: unit-image
          - get: version
            passed: [build-rc]
            trigger: true
          - get: linux-rc
            resource: linux-amd64-rc
            passed: [build-rc]
            trigger: true
          - get: windows-rc
            resource: windows-amd64-rc
            passed: [build-rc]
            trigger: true
          - get: concourse-release-repo
          - get: ci
      - task: bump-concourse-blobs
        file: ci/tasks/bump-concourse-blobs/task.yml
        image: unit-image
        params: { GCP_JSON_KEY: ((concourse_artifacts_json_key)) }
      - put: concourse-release-repo
        no_get: true
        inputs: detect
        params: { repository: bumped-concourse-release-repo }

  - name: bosh-upload-releases
    public: true
    serial: true
    plan:
      - in_parallel:
          # these don't trigger, to ensure that the job gets triggered by
          # concourse-release, which is unfortunately decoupled from the resource
          # that we 'put' to.
          - get: concourse
            passed: [bosh-bump]
          - get: unit-image
          - get: version
            passed: [bosh-bump]
          - get: concourse-release
            trigger: true
          - get: postgres-release
            trigger: true
          - get: bpm-release
            trigger: true
          - get: vault-release
            trigger: true
          - get: credhub-release
            trigger: true
          - get: uaa-release
            trigger: true
          - get: ci
      - task: upload-releases
        tags: [bosh]
        file: ci/tasks/upload-bosh-releases/task.yml
        image: unit-image
        params:
          BOSH_ENVIRONMENT: https://10.0.0.6:25555
          BOSH_CA_CERT: ((testing_bosh_ca_cert))
          BOSH_CLIENT: ((testing_bosh_client.id))
          BOSH_CLIENT_SECRET: ((testing_bosh_client.secret))

  - name: bosh-smoke
    public: true
    serial: true
    plan:
      - in_parallel:
          # these don't trigger, to ensure that the job gets triggered by
          # concourse-release, which is unfortunately decoupled from the resource
          # that we 'put' to.
          - get: concourse
            passed: [bosh-upload-releases]
          - get: unit-image
          - get: version
            passed: [bosh-upload-releases]
          - get: concourse-release
            passed: [bosh-upload-releases]
            trigger: true
          - get: postgres-release
            passed: [bosh-upload-releases]
            trigger: true
          - get: bpm-release
            passed: [bosh-upload-releases]
            trigger: true
          - get: gcp-ubuntu-stemcell
            trigger: true
          - get: ci
      - put: smoke-deployment
        tags: [bosh]
        params:
          manifest: ci/deployments/bosh-smoke.yml
          releases:
            - concourse-release/*.tgz
            - postgres-release/*.tgz
            - bpm-release/*.tgz
          stemcells:
            - gcp-ubuntu-stemcell/*.tgz
          vars:
            deployment_name: ((concourse_smoke_deployment_name))
            stemcell_variant: ((stemcell_name))
      - task: discover-bosh-endpoint-info
        tags: [bosh]
        file: ci/tasks/discover-bosh-endpoint-info/task.yml
        image: unit-image
        params:
          BOSH_ENVIRONMENT: https://10.0.0.6:25555
          BOSH_CA_CERT: ((testing_bosh_ca_cert))
          BOSH_CLIENT: ((testing_bosh_client.id))
          BOSH_CLIENT_SECRET: ((testing_bosh_client.secret))
          BOSH_DEPLOYMENT: ((concourse_smoke_deployment_name))
          BOSH_INSTANCE_GROUP: concourse
      - task: smoke
        tags: [bosh]
        image: unit-image
        file: ci/tasks/smoke-test/task.yml
        timeout: 1h

  - name: create-draft-release
    public: true
    plan:
      - in_parallel:
          - get: ci
          - get: concourse
            passed:
              - build-rc
              - bosh-smoke
              - bosh-check-props
          - get: final-version
            resource: version
            params: { bump: final }
            passed:
              - build-rc
              - bosh-smoke
              - bosh-check-props
          - get: unit-image
          - get: linux-amd64-rc
            passed: [build-rc, build-rc-image, bosh-check-props]
          - get: linux-arm64-rc
            passed: [build-rc, build-rc-image]
          - get: windows-amd64-rc
            passed: [build-rc]
          - get: darwin-amd64-rc
            passed: [build-rc]
          - get: darwin-arm64-rc
            passed: [build-rc]
          - get: concourse-rc-image
            passed: [k8s-topgun, build-rc-image]
          - get: concourse-release
            passed: [bosh-smoke]
            params: { tarball: false }
          - get: bpm-release
            passed: [bosh-smoke]
          - get: postgres-release
            passed: [bosh-smoke]
      - in_parallel:
          - task: build-release-name
            image: unit-image
            file: ci/tasks/build-release-name/task.yml
            input_mapping: { version: final-version }
          - do:
              - task: extract-resource-type-versions
                image: unit-image
                file: ci/tasks/extract-resource-type-versions/task.yml
                input_mapping:
                  linux-rc: linux-amd64-rc
              - task: build-release-notes
                image: unit-image
                file: ci/tasks/build-release-notes/task.yml
      - put: concourse-draft-release
        no_get: true
        inputs: detect
        params:
          commitish: concourse/.git/ref
          tag: final-version/version
          tag_prefix: v
          name: release-name/release-name
          body: built-notes/notes.md
          generate_release_notes: true

  - name: shipit
    public: true
    serial_groups: [version]
    plan:
      - in_parallel:
          - get: concourse
            passed: [create-draft-release]
          - get: unit-image
          - get: final-version
            resource: version
            params: { bump: final }
            passed: [create-draft-release]
          - get: linux-amd64-rc
            passed: [create-draft-release]
          - get: linux-arm64-rc
            passed: [create-draft-release]
          - get: windows-amd64-rc
            passed: [create-draft-release]
          - get: darwin-amd64-rc
            passed: [create-draft-release]
          - get: darwin-arm64-rc
            passed: [create-draft-release]
          - get: concourse-rc-image
            passed: [create-draft-release]
          - get: concourse-release
            passed: [create-draft-release]
            params: { tarball: false }
          - get: bpm-release
            passed: [create-draft-release]
          - get: postgres-release
            passed: [create-draft-release]
          - get: gcp-ubuntu-stemcell
            passed: [bosh-smoke]
      - put: version
        no_get: true
        inputs: detect
        params: { file: final-version/version }

  - name: publish-binaries
    serial: true
    plan:
      - in_parallel:
          - get: version
            passed: [shipit]
            trigger: true
          - get: concourse
            passed: [shipit]
          - get: unit-image
          - get: linux-amd64-rc
            passed: [shipit]
          - get: linux-arm64-rc
            passed: [shipit]
          - get: windows-amd64-rc
            passed: [shipit]
          - get: darwin-amd64-rc
            passed: [shipit]
          - get: darwin-arm64-rc
            passed: [shipit]
          - get: ci
      - in_parallel:
          - task: prep-release-assets
            file: ci/tasks/prep-release-assets/task.yml
            image: unit-image
          - task: build-release-name
            file: ci/tasks/build-release-name/task.yml
            image: unit-image
      - put: concourse-github-release
        no_get: true
        inputs: detect
        params:
          commitish: concourse/.git/ref
          tag: version/version
          tag_prefix: v
          name: release-name/release-name
          globs:
            - concourse-linux/concourse-*.tgz
            - concourse-windows/concourse-*.zip
            - concourse-darwin/concourse-*.tgz
            - fly-linux/fly-*.tgz
            - fly-windows/fly-*.zip
            - fly-darwin/fly-*.tgz
            - concourse-linux/*.sha1
            - concourse-windows/*.sha1
            - concourse-darwin/*.sha1
            - fly-linux/*.sha1
            - fly-windows/*.sha1
            - fly-darwin/*.sha1

  - name: publish-bosh-release
    serial: true
    plan:
      - in_parallel:
          - get: version
            passed: [shipit]
            trigger: true
          - get: concourse-release
            passed: [shipit]
      - put: concourse-release-final
        no_get: true
        inputs: detect
        params:
          tarball: concourse-release/*.tgz
          version: version/version

  - name: bump-cbd-versions
    serial: true
    plan:
      - in_parallel:
          - get: concourse-boshio
            trigger: true
          - get: unit-image
          - get: cbd
          - get: version
            passed: [shipit]
          - get: bpm-release
            passed: [shipit]
          - get: postgres-release
            passed: [shipit]
          - get: credhub-release
          - get: uaa-release
          - get: bbr-sdk-release
          - get: windows-utilities-release
      - task: bump-versions
        file: cbd/ci/bump-versions.yml
        input_mapping: { concourse-bosh-deployment: cbd }
        image: unit-image
      - put: cbd
        no_get: true
        inputs: detect
        params:
          repository: bumped-repo
          merge: true

  - name: pin-resource-type-versions
    serial: true
    plan:
      - in_parallel:
          - get: linux-rc
            resource: linux-amd64-rc
            passed: [shipit]
            trigger: true
          - get: ci
          - get: unit-image
      - task: extract-resource-type-versions
        image: unit-image
        file: ci/tasks/extract-resource-type-versions/task.yml
      - task: pin-resource-type-versions
        image: unit-image
        file: ci/tasks/pin-resource-type-versions/task.yml
        params:
          RELEASE_MINOR: ((release_minor))
        output_mapping: { ci: bumped-ci }
      - put: ci
        inputs: detect
        no_get: true
        params:
          repository: bumped-ci
          rebase: true

  - name: publish-image
    serial: true
    plan:
      - in_parallel:
          - get: version
            passed: [shipit]
            trigger: true
          - get: concourse-rc-image
            passed: [shipit]
            params: { format: oci-layout }
      - load_var: image_version
        file: version/version
      - put: concourse-image
        no_get: true
        inputs: detect
        params:
          image: concourse-rc-image/oci
          version: ((.:image_version))
          bump_aliases: true

  - name: patch
    public: true
    serial_groups: [version]
    plan:
      - get: version
        passed: [shipit]
        trigger: true
        params:
          bump: patch
          pre: rc
      - put: version
        no_get: true
        inputs: detect
        params:
          file: version/version

resources:
  - name: concourse
    type: git
    icon: *git-icon
    source:
      uri: https://github.com/concourse/concourse.git
      branch: release/((release_minor)).x
      ignore_paths:
        - release-notes/

  - name: ci
    type: git
    icon: *git-icon
    source:
      uri: git@github.com:concourse/ci.git
      branch: ((ci_branch))
      private_key: ((deploy_keys.ci-repo-push))

  - name: ci-pr-pipeline
    type: git
    icon: github
    source:
      uri: https://github.com/concourse/ci
      branch: ((ci_branch))
      paths:
        - pipelines/pr.yml

  - name: infrastructure
    type: git
    icon: github
    source:
      uri: git@github.com:concourse/infrastructure.git
      branch: master
      private_key: ((greenpeace_private_key))

  - name: infrastructure-bump
    type: git
    icon: github
    source:
      uri: git@github.com:concourse/infrastructure.git
      branch: master
      private_key: ((greenpeace_private_key))

  - name: concourse-docker
    type: git
    icon: *git-icon
    source:
      uri: https://github.com/concourse/concourse-docker.git
      branch: release/((release_minor)).x

  - name: resource-types-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/resource-types
      tag: release-((release_minor))
      username: ((docker.username))
      password: ((docker.password))

  - name: dev-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/dev
      username: ((docker.username))
      password: ((docker.password))
      tag: release-((release_minor))

  - name: concourse-rc-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/concourse-rc
      username: ((docker.username))
      password: ((docker.password))
      tag: release-((release_minor))

  - name: latest-concourse-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/concourse
      username: ((docker.username))
      password: ((docker.password))
      tag: ((latest_release))

  - name: concourse-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/concourse
      username: ((docker.username))
      password: ((docker.password))

  - name: version
    type: semver
    icon: tag
    source:
      driver: gcs
      json_key: ((concourse_artifacts_json_key))

      bucket: concourse-artifacts
      key: version-((release_minor))
      initial_version: ((release_minor)).0-rc.0

  - name: linux-amd64-rc
    type: gcs
    icon: linux
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      regexp: rcs/concourse-(.*)\.linux\.amd64\.tgz

  - name: linux-arm64-rc
    type: gcs
    icon: linux
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      regexp: rcs/concourse-(.*)\.linux\.arm64\.tgz

  - name: windows-amd64-rc
    type: gcs
    icon: microsoft-windows
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      regexp: rcs/concourse-(.*)\.windows\.amd64\.zip

  - name: darwin-amd64-rc
    type: gcs
    icon: apple
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      regexp: rcs/concourse-(.*)\.darwin\.amd64\.tgz

  - name: darwin-arm64-rc
    type: gcs
    icon: apple
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      regexp: rcs/concourse-(.*)\.darwin\.arm64\.tgz

  - name: concourse-release
    type: bosh-release
    icon: *release-icon
    source:
      uri: https://github.com/concourse/concourse-bosh-release
      branch: release/((release_minor)).x
      dev_releases: true
      private_config: &release_private_config
        blobstore:
          provider: gcs
          options:
            credentials_source: static
            json_key: ((concourse_artifacts_json_key))

  - name: concourse-release-final
    type: bosh-release
    icon: *release-icon
    source:
      uri: git@github.com:concourse/concourse-bosh-release
      branch: master
      private_config: *release_private_config
      private_key: ((concourse_release_deploy_key))

  - name: concourse-release-repo
    type: git
    icon: *git-icon
    source:
      uri: git@github.com:concourse/concourse-bosh-release
      branch: release/((release_minor)).x
      private_key: ((concourse_release_deploy_key))

  - name: smoke-deployment
    tags: [bosh]
    type: bosh-deployment
    icon: fire
    source:
      target: https://10.0.0.6:25555
      client: ((testing_bosh_client.id))
      client_secret: ((testing_bosh_client.secret))
      ca_cert: ((testing_bosh_ca_cert))
      deployment: ((concourse_smoke_deployment_name))

  - name: concourse-chart
    type: git
    icon: *git-icon
    source:
      uri: git@github.com:concourse/concourse-chart.git
      branch: release/((release_minor)).x
      private_key: ((concourse_chart_private_key))

  - name: prometheus-chart
    type: helm-chart
    icon: &helm-icon ship-wheel
    source:
      chart: prometheus-community/prometheus
      repos:
        - name: prometheus-community
          url: https://prometheus-community.github.io/helm-charts

  # Using the git instead of helm-chart resource because Bitnami charts are
  # hosted on Docker Hub and we sometimes run into their rate limits
  - name: postgresql-chart-git
    type: git
    check_every: 24h
    source:
      uri: "https://github.com/bitnami/charts.git"
      tag_filter: postgresql/((postgresql_major))*

  - name: concourse-draft-release
    type: github-release
    icon: *release-icon
    source:
      drafts: true
      owner: concourse
      repository: concourse
      access_token: ((concourse_bot_access_token))

  - name: concourse-github-release
    type: github-release
    icon: *release-icon
    source:
      owner: concourse
      repository: concourse
      access_token: ((concourse_bot_access_token))

  - name: concourse-boshio
    type: bosh-io-release
    icon: *release-icon
    source:
      repository: concourse/concourse-bosh-release
      regexp: ^((release_minor)).*

  - name: unit-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/unit
      tag: latest
      username: ((docker.username))
      password: ((docker.password))

  - name: golang-builder-image
    type: registry-image
    icon: *image-icon
    source:
      repository: concourse/golang-builder
      tag: latest
      username: ((docker.username))
      password: ((docker.password))

  - name: oci-build-task
    type: registry-image
    icon: *image-icon
    source: { repository: concourse/oci-build-task }

  - name: gcp-ubuntu-stemcell
    type: bosh-io-stemcell
    icon: *release-icon
    source: { name: bosh-google-kvm-ubuntu-((stemcell_name))-go_agent }

  - name: cbd
    type: git
    icon: *git-icon
    source:
      uri: git@github.com:concourse/concourse-bosh-deployment.git
      branch: release/((release_minor)).x
      private_key: ((concourse_deployment_repo_private_key))

  - name: postgres-image
    type: registry-image
    icon: *image-icon
    source: { repository: postgres }

  - name: vault-image
    type: registry-image
    icon: *image-icon
    source: { repository: vault }

  - name: dumb-init
    type: github-release
    icon: *release-icon
    source:
      owner: Yelp
      repository: dumb-init
      access_token: ((concourse_github_dummy.access_token))

  - name: gdn
    type: github-release
    icon: *release-icon
    source:
      owner: cloudfoundry
      repository: garden-runc-release
      semver_constraint: ((dep_bin_versions.gdn))
      access_token: ((concourse_github_dummy.access_token))

  - name: containerd
    type: github-release
    icon: *release-icon
    source:
      owner: containerd
      repository: containerd
      semver_constraint: ((dep_bin_versions.containerd))
      access_token: ((concourse_github_dummy.access_token))

  - name: runc
    type: github-release
    icon: *release-icon
    source:
      owner: opencontainers
      repository: runc
      semver_constraint: ((dep_bin_versions.runc))
      access_token: ((concourse_github_dummy.access_token))

  - name: cni
    type: github-release
    icon: *release-icon
    source:
      owner: containernetworking
      repository: plugins
      semver_constraint: ((dep_bin_versions.cni))
      access_token: ((concourse_github_dummy.access_token))

  - name: postgres-release
    type: bosh-io-release
    icon: *release-icon
    source: { repository: cloudfoundry/postgres-release }

  - name: bpm-release
    type: bosh-io-release
    icon: *release-icon
    source:
      repository: cloudfoundry/bpm-release

  - name: vault-release
    type: bosh-io-release
    icon: *release-icon
    source:
      repository: vito/vault-boshrelease

  - name: credhub-release
    type: bosh-io-release
    icon: *release-icon
    source: { repository: pivotal-cf/credhub-release }

  - name: uaa-release
    type: bosh-io-release
    icon: *release-icon
    source: { repository: cloudfoundry/uaa-release }

  - name: bbr-sdk-release
    type: bosh-io-release
    icon: *release-icon
    source:
      repository: cloudfoundry-incubator/backup-and-restore-sdk-release

  - name: windows-utilities-release
    type: bosh-io-release
    icon: *release-icon
    source:
      repository: cloudfoundry-incubator/windows-utilities-release

  - name: mock-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/mock-resource
      semver_constraint: ((resource_type_versions.mock))
      username: ((docker.username))
      password: ((docker.password))

  - name: bosh-io-release-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/bosh-io-release-resource
      semver_constraint: ((resource_type_versions.bosh-io-release))
      username: ((docker.username))
      password: ((docker.password))

  - name: bosh-io-stemcell-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/bosh-io-stemcell-resource
      semver_constraint: ((resource_type_versions.bosh-io-stemcell))
      username: ((docker.username))
      password: ((docker.password))

  - name: docker-image-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/docker-image-resource
      semver_constraint: ((resource_type_versions.docker-image))
      username: ((docker.username))
      password: ((docker.password))

  - name: git-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/git-resource
      semver_constraint: ((resource_type_versions.git))
      username: ((docker.username))
      password: ((docker.password))

  - name: github-release-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/github-release-resource
      semver_constraint: ((resource_type_versions.github-release))
      username: ((docker.username))
      password: ((docker.password))

  - name: hg-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/hg-resource
      semver_constraint: ((resource_type_versions.hg))
      username: ((docker.username))
      password: ((docker.password))

  - name: pool-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/pool-resource
      semver_constraint: ((resource_type_versions.pool))
      username: ((docker.username))
      password: ((docker.password))

  - name: registry-image-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/registry-image-resource
      semver_constraint: ((resource_type_versions.registry-image))
      username: ((docker.username))
      password: ((docker.password))

  - name: s3-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/s3-resource
      semver_constraint: ((resource_type_versions.s3))
      username: ((docker.username))
      password: ((docker.password))

  - name: semver-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/semver-resource
      semver_constraint: ((resource_type_versions.semver))
      username: ((docker.username))
      password: ((docker.password))

  - name: time-resource
    type: registry-image
    icon: *release-icon
    source:
      repository: concourse/time-resource
      semver_constraint: ((resource_type_versions.time))
      username: ((docker.username))
      password: ((docker.password))

  - name: periodic-check
    icon: clock
    type: time
    source:
      interval: 24h

  - name: concourse-prs
    type: pull-request
    check_every: 2m
    source:
      repository: concourse/concourse
      access_token: ((pull_requests_access_token))
      base_branch: release/((release_minor)).x

  - name: wolfi-base
    type: registry-image
    check_every: 12h
    source:
      repository: cgr.dev/chainguard/wolfi-base
      tag: latest
