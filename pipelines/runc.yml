resource_types:
  - name: gcs
    type: registry-image
    source: { repository: frodenas/gcs-resource }

resources:
  - name: golang-builder-image
    type: registry-image
    icon: docker
    source:
      repository: concourse/golang-builder
      tag: latest
      username: ((docker.username))
      password: ((docker.password))

  - name: oci-build-task
    type: registry-image
    icon: docker
    source: { repository: concourse/oci-build-task }

  - name: ci
    type: git
    icon: github
    source:
      uri: https://github.com/concourse/ci.git
      branch: runc

  - name: runc
    type: github-release
    icon: github
    check_every: 24h
    source:
      owner: opencontainers
      repository: runc

  - name: runc-amd64
    type: gcs
    icon: linux
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      versioned_file: runc/runc.amd64

  - name: runc-arm64
    type: gcs
    icon: linux
    source:
      bucket: concourse-artifacts
      json_key: ((concourse_artifacts_json_key))
      versioned_file: runc/runc.arm64

jobs:
  - name: runc
    plan:
      - in_parallel:
        - get: ci
        - get: runc
          trigger: true
          params:
            globs: [none]
            include_source_tarball: true
        - get: oci-build-task
        - get: golang-builder-image
          trigger: true
          params: { format: oci-layout }
      - task: build-runc-binaries
        privileged: true
        image: oci-build-task
        file: ci/tasks/runc/task.yml
      - in_parallel:
        - put: runc-amd64
          no_get: true
          params:
            file: runc-bin/runc.amd64
        - put: runc-arm64
          no_get: true
          params:
            file: runc-bin/runc.arm64

